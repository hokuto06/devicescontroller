<!-- Incluye jQuery (asegúrate de agregarlo en tu proyecto) -->
{% extends "base.html" %}
{% load static %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<div id="device-detail-container">
    <h3 class="breadcrumb-item active">Detalle del Dispositivo</h3>
</div>
<div class="card mb-4">
    <div class="card-body">
        <button id="updateButton">Actualizar Dispositivo</button>
        <a href="{% url  'update_device' device.id  %}">Actualizar</a>
    </div>
</div>
<div class="container-fluid px-4">
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        {{ device.deviceName }}
    </div>    
    <div class="card-body">
        <div id="device-detail-container">
        <table>
            <tr><td>Host: {{ device.host_name }}</td></tr>
            <tr><td>Mac: {{ device.mac_address }}</td></tr>
            <tr><td>Ip: {{ device.ip_address }}</td></tr>
            <tr><td>Version: {{ device.version }}</td></tr>
            <tr><td>Controller: {{ device.controller_status }}</td></tr>
        </table>
        {% if device.clientes %}
        <form id="myForm" method="post" action="{% url 'config-new-one' %}">
            {% csrf_token %}        
        <table class="table">
            <thead>
                <tr>
                    <th>Address</th>
                    <th>Mac</th>
                    <th>Server</th>
                    <th>
                        <input class="no-sort" type="checkbox" id="seleccionarTodos">
                    </th>
                </tr>
                <tbody>
            {% for cliente in device.clientes %}
                <tr>
                    <td>{{ cliente.address }}</td>
                    <td>{{ cliente.mac }}</td>
                    <td>{{ cliente.server }}</td>
                    <td>
                        <input type="checkbox" class="checkbox" name="clientes_seleccionados" value="{{ cliente.address }}" data-mac="{{ cliente.mac }}" data-group="{{ device.group_name }}">
                    </td>                    
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" id="enviar" disabled>Enviar</button>
    </form>        
    {% else %}
        <p>No hay clientes disponibles.</p>
    {% endif %}
    
    </div>
</div>
</div>
<script>

$(document).ready(function() {
    $('#datatablesSimple').DataTable({
        "columnDefs": [{
            "targets": 'no-sort',
            "orderable": false,
        }]
    });

    const seleccionarTodosCheckbox = document.getElementById('seleccionarTodos');
    const checkboxes = document.querySelectorAll('.checkbox');
    const enviarButton = document.getElementById('enviar');

    seleccionarTodosCheckbox.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = seleccionarTodosCheckbox.checked;
        });
        const algunSeleccionado = [...checkboxes].some(checkbox => checkbox.checked);
        enviarButton.disabled = !algunSeleccionado;
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const algunSeleccionado = [...checkboxes].some(checkbox => checkbox.checked);
            enviarButton.disabled = !algunSeleccionado;
        });
    });

    $('#myForm').submit(function(event) {
        event.preventDefault();
        const clientesSeleccionados = [...checkboxes].filter(checkbox => checkbox.checked).map(checkbox => checkbox.value);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: {
                'clientes_seleccionados': clientesSeleccionados,
                'csrfmiddlewaretoken': csrfToken
            },
            success: function(response) {
                console.log('Success:', response);
                // Aquí puedes manejar la respuesta exitosa del servidor
            },
            error: function(error) {
                console.log('Error:', error);
                // Aquí puedes manejar cualquier error que ocurra durante la solicitud
            }
        });
    });
});

</script>
{% endblock %}
